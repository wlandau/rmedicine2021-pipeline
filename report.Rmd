---
title: "R Medicine: Target Markdown and stantargets"
output: html_document
---

```{r setup, include = FALSE}
library(targets)
tar_unscript()
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

```{targets settings, tar_globals = TRUE}
tar_option_set(
  packages = c("tidyverse", "trialr")
)
options(clustermq.scheduler = "sge", clustermq.template = "sge.tmpl")
```
# Data generation

The following function simulates one rep of a clinical trial data from the prior predictive distribution of an MMRM model. The model coefficients `beta` come from independent `Normal(0, sd = 10)` distributions, and the covariance matrix comes from an `Inverse-Wishart(df = n_visits, scale = diag(n_visits))` distribution. To control for numerical issues, the covariance matrix is restricted such that each matrix element lies between -500 and 500 (via rejection sampling). The function returns a Stan data list and accepts arguments `n_patients` (number of patients in the trial), `n_visits` (number of scheduled study visits, e.g. repeated measures per patient), and `n_arms` (number of study arms, e.g. treatment groups).

```{targets data, tar_globals = TRUE}
simulate_data <- function(n_patients = 500, n_visits = 4, n_arms = 2) {
  structure <- tibble(patient = as.character(seq_len(n_patients))) %>%
    mutate(arm = as.character(rep(seq_len(n_arms), each = n_patients / n_arms))) %>%
    mutate(covariate1 = rnorm(n()), covariate2 = rnorm(n())) %>%
    expand_grid(visit = as.character(seq_len(n_visits))) %>%
    mutate(group = paste0(arm, visit))
  x <- model.matrix(~ 0 + covariate1 + covariate2 + group, data = structure) %>%
    as.matrix()
  beta <- rnorm(ncol(x), 10)
  covariance <- NULL
  while (is.null(covariance) || max(abs(covariance)) > 100) {
    rho <- rlkjcorr(n = 1, K = n_visits, eta = 1)
    sigma <- rcauchy(n = n_visits, location = 0, scale = 1)
    covariance <- diag(sigma) %*% rho %*% diag(sigma)
  }
  data <- structure %>%
    mutate(x_beta = as.numeric(x %*% beta)) %>%
    group_by(patient) %>%
    mutate(response = MASS::mvrnorm(n = 1L, mu = x_beta, Sigma = covariance)) %>%
    ungroup() %>%
    select(response, arm, patient, visit, covariate1, covariate2, group)
  list(
    data = data,
    y = data$response,
    x = x,
    n_arms = n_arms,
    n_beta = length(beta),
    n_observations = n_patients * n_visits,
    n_patients = n_patients,
    n_visits = n_visits,
    .join_data = list(
      beta = beta,
      sigma = sigma,
      rho = rho
    )
  )
}
```


